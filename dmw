#!/bin/bash
# Select media (video) file from dmenu and play it with mpv
# Download subtitle with periscope (https://github.com/patrickdessalle/periscope)

find_mkv_files(){ find ~/downloads -iname "*.mkv";}
find_mp4_files(){ find ~/downloads -iname "*.mp4";}
find_srt_files(){ find ~/downloads -iname "*.srt";}
find_mp4_srt(){ find ~/downloads -iname ${file_name%.mp4}.srt;}
find_mkv_srt(){ find ~/downloads -iname ${file_name%.mkv}.srt;}
play(){ mpv $selected_file; }

file_name=$( ( find_mkv_files  && find_mp4_files  && find_srt_files ) | awk -F "/" '{print $NF}' | dmenu -i -l 20 -fn 'monospace-12' )

case $file_name in

    "") exit;;
    *) if [[ "$file_name" == *[\[\]]* ]]; then file_name=$(sed 's/\[/\\[/g;s/\]/\\]/g' <<< $file_name) ; fi
   ;;

esac

selected_file=$(find -iname $file_name)

if [[ ! -e $(find_mkv_srt) ]] && [[ ! -e $(find_mp4_srt) ]]; then
    subtitle=$(echo -e "yes\nno" | dmenu -p "Download subtitle before start?" -i -fn 'monospace-12')

    case $subtitle in
        yes) dmenu -p "Downloading subtitle..." -i -l 1 -fn 'monospace-12'  & 

            if pgrep "dmenu" > /dev/null;then
                sleep 2
                pkill dmenu
            fi && periscope -l en $(find ~/downloads -iname $file_name)

            if [ $? -ne 0 ]; then subtitle_error=$(echo -e "yes\nno"  |  dmenu -p "Can't find subtitle. Play anyway?" -i -fn 'monospace-12')

                case $subtitle_error in
                    yes) play;;
                    no) exit;;
                esac

            else
                play

            fi
             ;;

        no) play ;;
    esac

else
    play
fi
